<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガントチャートとFirestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .gantt-chart {
            display: grid;
            grid-template-columns: 200px repeat(var(--total-days), minmax(30px, 1fr));
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .gantt-chart-header, .gantt-chart-row {
            display: contents;
        }
        .gantt-chart-cell {
            padding: 1rem;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            background-color: #fff;
            display: flex;
            align-items: center;
        }
        .gantt-chart-bar {
            height: 60%; /* 高さを短く調整 */
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 0 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 0 4px; /* バー間の余白 */
            box-sizing: border-box; /* パディングとボーダーを幅に含める */
            z-index: 10;
        }
        .gantt-chart-bar:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .task-name-cell {
            cursor: pointer;
            border-left: none !important;
        }
        .task-bar-cell {
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen">

    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-5xl">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">プロジェクトタイムライン</h1>
            <div id="user-id" class="text-sm font-medium text-gray-500 bg-gray-100 p-2 rounded-lg"></div>
        </div>

        <!-- プロジェクト管理 -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold text-gray-700 mb-4">プロジェクト管理</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label for="new-project-name" class="block text-sm font-medium text-gray-700">新しいプロジェクト名</label>
                    <div class="mt-1 flex gap-2">
                        <input type="text" id="new-project-name" required class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <button id="add-project-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">追加</button>
                    </div>
                </div>
                <div class="flex-1">
                    <label for="project-select" class="block text-sm font-medium text-gray-700">プロジェクトを選択</label>
                    <select id="project-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <!-- オプションはJSによってここにレンダリングされます -->
                    </select>
                </div>
            </div>
        </div>

        <!-- タスク入力フォーム -->
        <div id="task-management-section" class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
            <h2 class="text-xl font-bold text-gray-700 mb-4">タスク管理</h2>
            <form id="task-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="task-name" class="block text-sm font-medium text-gray-700">タスク名</label>
                        <input type="text" id="task-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="task-assignee" class="block text-sm font-medium text-gray-700">担当者</label>
                        <input type="text" id="task-assignee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">開始日</label>
                        <input type="date" id="start-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">終了日</label>
                        <input type="date" id="end-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="task-status" class="block text-sm font-medium text-gray-700">ステータス</label>
                        <select id="task-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="pending">保留中</option>
                            <option value="in-progress">進行中</option>
                            <option value="complete">完了</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    タスクを追加
                </button>
            </form>
        </div>

        <!-- ガントチャート -->
        <div id="gantt-chart-section" class="gantt-chart-container bg-gray-50 rounded-lg p-4 overflow-x-auto hidden">
            <div id="gantt-chart" class="gantt-chart min-w-[800px]">
                <!-- チャート内容はJavaScriptによってここに生成されます -->
            </div>
        </div>

        <!-- 削除確認モーダル -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full space-y-4">
                <h3 class="text-lg font-bold">タスクを削除</h3>
                <p>このタスクを削除してもよろしいですか？</p>
                <div class="flex justify-end gap-4">
                    <button id="cancel-delete" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">キャンセル</button>
                    <button id="confirm-delete" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700">削除</button>
                </div>
            </div>
        </div>

        <!-- 編集モーダル -->
        <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full space-y-4">
                <h3 class="text-lg font-bold">タスクを編集</h3>
                <form id="edit-task-form" class="space-y-4">
                    <div>
                        <label for="edit-task-name" class="block text-sm font-medium text-gray-700">タスク名</label>
                        <input type="text" id="edit-task-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="edit-task-assignee" class="block text-sm font-medium text-gray-700">担当者</label>
                        <input type="text" id="edit-task-assignee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="edit-start-date" class="block text-sm font-medium text-gray-700">開始日</label>
                        <input type="date" id="edit-start-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="edit-end-date" class="block text-sm font-medium text-gray-700">終了日</label>
                        <input type="date" id="edit-end-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="edit-task-status" class="block text-sm font-medium text-gray-700">ステータス</label>
                        <select id="edit-task-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="pending">保留中</option>
                            <option value="in-progress">進行中</option>
                            <option value="complete">完了</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="cancel-edit" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">キャンセル</button>
                        <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">変更を保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 環境によって提供されるグローバル変数
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebaseを初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let currentProjectId = null;
        let unsubscribeTasks = null; // タスクリスナーを管理する変数
        let currentTaskToEdit = null;

        // DOM要素
        const ganttChartEl = document.getElementById('gantt-chart');
        const taskForm = document.getElementById('task-form');
        const userIdEl = document.getElementById('user-id');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const editModal = document.getElementById('edit-modal');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const editTaskForm = document.getElementById('edit-task-form');
        const projectSelect = document.getElementById('project-select');
        const addProjectButton = document.getElementById('add-project-button');
        const newProjectNameInput = document.getElementById('new-project-name');
        const taskManagementSection = document.getElementById('task-management-section');
        const ganttChartSection = document.getElementById('gantt-chart-section');
        let taskToDeleteId = null;

        const dateToString = (date) => date.toISOString().split('T')[0];
        const stringToDate = (str) => {
            const date = new Date(str + 'T00:00:00');
            return new Date(date.getTime() + date.getTimezoneOffset() * 60000);
        };
        const ONE_DAY_MS = 1000 * 60 * 60 * 24;

        function getStatusClasses(status) {
            switch (status) {
                case 'pending': return 'bg-blue-500 hover:bg-blue-600';
                case 'in-progress': return 'bg-yellow-500 hover:bg-yellow-600';
                case 'complete': return 'bg-green-500 hover:bg-green-600';
                default: return 'bg-gray-500 hover:bg-gray-600';
            }
        }

        function renderGanttChart(tasks) {
            if (!tasks || tasks.length === 0) {
                ganttChartEl.innerHTML = '<div class="col-span-full text-center text-gray-500 p-8">表示するタスクはありません。新しいタスクを追加して開始してください！</div>';
                ganttChartEl.style.gridTemplateColumns = '200px 1fr'; // CSS変数が設定されない場合のフォールバック
                return;
            }
        
            // タスクの日付範囲を計算
            let allDates = tasks.flatMap(t => [stringToDate(t.startDate), stringToDate(t.endDate)]);
            if (allDates.length === 0) {
                ganttChartEl.innerHTML = '<div class="col-span-full text-center text-gray-500 p-8">表示するタスクはありません。新しいタスクを追加して開始してください！</div>';
                ganttChartEl.style.gridTemplateColumns = '200px 1fr'; // CSS変数が設定されない場合のフォールバック
                return;
            }
            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            const totalDays = Math.ceil((maxDate - minDate) / ONE_DAY_MS) + 1;
        
            ganttChartEl.innerHTML = '';
            ganttChartEl.style.setProperty('--total-days', totalDays);
        
            // ヘッダー行を生成
            const headerRow = document.createElement('div');
            headerRow.className = 'gantt-chart-header';
            headerRow.innerHTML += `<div class="gantt-chart-cell bg-gray-200 font-bold">タスク</div>`;
            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(minDate);
                currentDate.setDate(minDate.getDate() + i);
                const day = currentDate.getDate();
                const month = currentDate.toLocaleString('ja-JP', { month: 'short' });
                headerRow.innerHTML += `<div class="gantt-chart-cell bg-gray-200 text-center text-xs font-semibold">${month} ${day}</div>`;
            }
            ganttChartEl.appendChild(headerRow);
        
            // タスク行を生成
            tasks.forEach(task => {
                const startDate = stringToDate(task.startDate);
                const endDate = stringToDate(task.endDate);
                const taskDays = Math.ceil((endDate - startDate) / ONE_DAY_MS) + 1;
                const startDayOffset = Math.floor((startDate - minDate) / ONE_DAY_MS);
                
                // タスク名セル
                const taskNameCell = document.createElement('div');
                taskNameCell.className = 'gantt-chart-cell font-medium relative group task-name-cell';
                taskNameCell.textContent = `${task.name}${task.assignee ? ` (${task.assignee})` : ''}`;
                taskNameCell.onclick = () => showEditModal(task);
                
                // 削除ボタン
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded-full text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                `;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    showDeleteModal(task.id);
                };
                taskNameCell.appendChild(deleteBtn);
                ganttChartEl.appendChild(taskNameCell);
        
                // ガントバー
                const bar = document.createElement('div');
                bar.className = 'gantt-chart-bar';
                bar.textContent = `${task.name}${task.assignee ? ` (${task.assignee})` : ''}`;
                const statusClasses = getStatusClasses(task.status);
                if (statusClasses) {
                    statusClasses.split(' ').forEach(cls => bar.classList.add(cls));
                }
                
                // CSS Gridを使ってバーを配置
                bar.style.gridColumnStart = `${startDayOffset + 2}`;
                bar.style.gridColumnEnd = `span ${taskDays}`;
                
                bar.onclick = () => showEditModal(task);
                
                ganttChartEl.appendChild(bar);
            });
        }

        function showDeleteModal(taskId) {
            taskToDeleteId = taskId;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function showEditModal(task) {
            currentTaskToEdit = task;
            document.getElementById('edit-task-name').value = task.name;
            document.getElementById('edit-task-assignee').value = task.assignee || '';
            document.getElementById('edit-start-date').value = task.startDate;
            document.getElementById('edit-end-date').value = task.endDate;
            document.getElementById('edit-task-status').value = task.status;
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        cancelDeleteBtn.onclick = () => {
            deleteModal.classList.remove('flex');
            deleteModal.classList.add('hidden');
        };

        cancelEditBtn.onclick = () => {
            editModal.classList.remove('flex');
            editModal.classList.add('hidden');
        };

        confirmDeleteBtn.onclick = async () => {
            if (taskToDeleteId) {
                await deleteTask(taskToDeleteId);
                deleteModal.classList.remove('flex');
                deleteModal.classList.add('hidden');
                taskToDeleteId = null;
            }
        };

        editTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedTask = {
                name: document.getElementById('edit-task-name').value,
                assignee: document.getElementById('edit-task-assignee').value,
                startDate: document.getElementById('edit-start-date').value,
                endDate: document.getElementById('edit-end-date').value,
                status: document.getElementById('edit-task-status').value
            };
            await updateTask(currentTaskToEdit.id, updatedTask);
            editModal.classList.remove('flex');
            editModal.classList.add('hidden');
            currentTaskToEdit = null;
        });

        async function addProject(projectName) {
            if (!userId) {
                console.error("ユーザーが認証されていません。");
                return;
            }
            try {
                const projectsCol = collection(db, `artifacts/${appId}/users/${userId}/projects`);
                await addDoc(projectsCol, { name: projectName });
            } catch (e) {
                console.error("プロジェクトの追加中にエラーが発生しました: ", e);
            }
        }

        async function addTask(task) {
            if (!currentProjectId) {
                console.error("プロジェクトが選択されていません。");
                return;
            }
            try {
                const tasksCol = collection(db, `artifacts/${appId}/users/${userId}/projects/${currentProjectId}/tasks`);
                await addDoc(tasksCol, { ...task, createdBy: userId });
            } catch (e) {
                console.error("ドキュメントの追加中にエラーが発生しました: ", e);
            }
        }

        async function updateTask(taskId, taskData) {
            if (!currentProjectId) {
                console.error("プロジェクトが選択されていません。");
                return;
            }
            try {
                const taskRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${currentProjectId}/tasks`, taskId);
                await updateDoc(taskRef, taskData);
            } catch (e) {
                console.error("ドキュメントの更新中にエラーが発生しました: ", e);
            }
        }

        async function deleteTask(taskId) {
            if (!currentProjectId) {
                console.error("プロジェクトが選択されていません。");
                return;
            }
            try {
                const taskRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${currentProjectId}/tasks`, taskId);
                await deleteDoc(taskRef);
            } catch (e) {
                console.error("ドキュメントの削除中にエラーが発生しました: ", e);
            }
        }

        function renderProjects(projects) {
            projectSelect.innerHTML = '';
            if (projects.length === 0) {
                projectSelect.innerHTML = '<option value="">プロジェクトがありません</option>';
                taskManagementSection.classList.add('hidden');
                ganttChartSection.classList.add('hidden');
                currentProjectId = null;
            } else {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    projectSelect.appendChild(option);
                });
                projectSelect.value = projects[0].id;
                projectSelect.dispatchEvent(new Event('change'));
            }
        }

        function listenToTasks(projectId) {
            if (unsubscribeTasks) {
                unsubscribeTasks(); // 既存のリスナーを解除
            }
            if (!projectId) return;

            taskManagementSection.classList.remove('hidden');
            ganttChartSection.classList.remove('hidden');

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/projects/${projectId}/tasks`));
            unsubscribeTasks = onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                renderGanttChart(tasks);
            }, (error) => {
                console.error("タスクの取得中にエラーが発生しました: ", error);
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdEl.textContent = `ユーザーID: ${userId}`;
                
                const projectsCol = collection(db, `artifacts/${appId}/users/${userId}/projects`);
                onSnapshot(projectsCol, (snapshot) => {
                    const projects = [];
                    snapshot.forEach(doc => {
                        projects.push({ id: doc.id, name: doc.data().name });
                    });
                    renderProjects(projects);
                }, (error) => {
                    console.error("プロジェクトの取得中にエラーが発生しました: ", error);
                });
            }
        });

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch((error) => {
                console.error("カスタムトークンでのサインインに失敗しました:", error);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        addProjectButton.addEventListener('click', () => {
            const projectName = newProjectNameInput.value;
            if (projectName) {
                addProject(projectName);
                newProjectNameInput.value = '';
            }
        });
        
        projectSelect.addEventListener('change', (e) => {
            currentProjectId = e.target.value;
            listenToTasks(currentProjectId);
        });

        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const taskName = document.getElementById('task-name').value;
            const taskAssignee = document.getElementById('task-assignee').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const status = document.getElementById('task-status').value;

            const newTask = {
                name: taskName,
                assignee: taskAssignee,
                startDate: startDate,
                endDate: endDate,
                status: status
            };
            addTask(newTask);
            taskForm.reset();
        });
    </script>
</body>
</html>
